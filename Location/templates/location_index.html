<!DOCTYPE html>
<html>
<head>
  <title>Map Page</title>
  <link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
  <style>
  .map{
    height:400px;
    width:400px;
  }</style>
  <script src="https://openlayers.org/en/v3.19.1/build/ol.js" type="text/javascript"></script>
  <link href="//cdn.jsdelivr.net/openlayers.geocoder/latest/ol3-geocoder.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/openlayers.geocoder/latest/ol3-geocoder.js"></script>
</head>
<body>
  <div id="map" class="map"></div>
  <div id="overlay"></div>
  <div id="source">
    <label for="source_box">Source Point</label>
    <input id="source_box" type="text" />
    <input id="source_btn" type="button" value="Current location as start" />
    <input id="current" type="button" value="Go to current location" />
  </div>
  <div id="destination">
    <label for="destination_box">Destination Point</label>
    <input id="destination_box" type="text" />
  </div>
  <div id="route">
    <input id="route" type="button" value="Route" />
  </div>

  <script type="text/javascript">

  var locations=[,];

  function el(id){
    return document.getElementById(id);
  };

  var zoomlevel=5;


  var center = ol.proj.transform([80,20], 'EPSG:4326', 'EPSG:3857');

  var view = new ol.View({
    center: center,
    zoom: zoomlevel
  });

  var featureSource = new ol.source.Vector({});

  var layer = [new ol.layer.Tile({
    source: new ol.source.OSM()
  }),
  new ol.layer.Vector({
    source:featureSource
  })
];

  var overlay1=new ol.Overlay({
    element:el('overlay'),
    positioning:'bottom-center'
  });

  var map = new ol.Map({
    //renderer can be set to 'canvas', 'dom' or 'webgl'
    renderer: 'canvas',
    target: 'map',
    layers: layer,
    view: view
  });

  var geocoder=new Geocoder('nomatim',{
    provider:'osm',
    key:'',
    lang:'en-US',
    placeholder:'Search Destination...',
    limit:5,
    keepOpen:false,
    preventDefault:true
  });

  var geo_accuracy = new ol.Feature({
    name:"geo_accuracy"
  });
  geo_accuracy.setId('geo_accuracy');
  var geo_location = new ol.Feature({
    name:"geo_location"
  });
  geo_location.setId('geo_location');
  var address_location = new ol.Feature({
    name:"address_location"
  });
  address_location.setId('address_location');

  var pointStyle = new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({
        color: '#3399CC'
      }),
      stroke: new ol.style.Stroke({
        color: '#fff',
        width: 2
      })
    })
  })

  geo_location.setStyle(pointStyle);
  address_location.setStyle(pointStyle);

  map.addControl(geocoder);

  geocoder.on('addresschosen', function(evt) {
    // it's up to you
    var coordinates=evt.coordinate;
    console.info(coordinates);
    var degrees = ol.proj.transform(coordinates, 'EPSG:3857', 'EPSG:4326');
    // format a human readable version
    var hdms = ol.coordinate.toStringHDMS(degrees);

    el('destination_box').value=hdms;

    address_location.setGeometry(coordinates ?
      new ol.geom.Point(coordinates) : null);
      zoom=14;
      featureSource.addFeature(address_location);
    doPan(coordinates);

  });

  var geolocation = new ol.Geolocation({
    // take the projection to use from the map's view
    projection: view.getProjection()
  });

  // listen to changes in position
  geolocation.on('change', function(evt) {
    var coordinate=geolocation.getPosition();
    window.console.log(coordinate);
    doPan(coordinate);

  });

  geolocation.on('change:accuracyGeometry', function(){
    geo_accuracy.setGeometry(geolocation.getAccuracyGeometry());
  });


  geolocation.on('change:position', function() {
    var coordinates = geolocation.getPosition();
    geo_location.setGeometry(coordinates ?
      new ol.geom.Point(coordinates) : null);
      zoom=14;
      window.console.log(geolocation.getPosition());
      doPan(coordinates);
    });

    geolocation.setTracking(true);

    featureSource.addFeature(geo_accuracy);
    featureSource.addFeature(geo_location);



    var numOfPoints=0;
    var p="point";

    map.on('click', function(event){

      var coordinates=event.coordinate;
      numOfPoints=numOfPoints+1;
      var point= new ol.Feature();
      point.setId(p.concat(numOfPoints.toString()));
      point.setStyle(pointStyle);

      point.setGeometry(coordinates ?
        new ol.geom.Point(coordinates) : null);
        zoom=14;

      featureSource.addFeature(point);
      console.log(featureSource.getExtent);
});

  //  new ol.layer.Vector({
  //    map: map,
  //    source: new ol.source.Vector({
  //      features: point
  //    })
  //  });

    //event listeners
    el('source_btn').addEventListener('click',setCurrentLoc);
    el('route').addEventListener('click',route);
    el('current').addEventListener('click',setGeoAsCenter);

    function setGeoAsCenter(event){
      var coordinates=geolocation.getPosition();
      doPan(coordinates);
    }

    function setCurrentLoc(){
      var coordinates=geolocation.getPosition();
      var degrees = ol.proj.transform(coordinates, 'EPSG:3857', 'EPSG:4326');
      // format a human readable version
      var hdms = ol.coordinate.toStringHDMS(degrees);
      el('source_box').value=hdms;
      location[0]=coordinates;
      window.console.log(location)
    };

    function route(){
      var featureArray = featureSource.getFeatures();

      featureArray.forEach(function(feature){
        console.log(feature.getGeometry().getCoordinates());
        var bound_co=map.getView().calculateExtent(map.getSize());

        console.log(bound_co);


      });
    }

    function doPan(location) {
      // pan from the current center
      var pan = ol.animation.pan({
        source: map.getView().getCenter()
      });
      map.beforeRender(pan);
      // when we set the new location, the map will pan smoothly to it
      map.getView().setCenter(location);
      map.getView().setZoom(12);
    };

  </script>
</body>
</html>
